const OPENING_HOURS={0:null,1:{start:9,end:14,afternoon_start:18,afternoon_end:21},2:{start:9,end:14,afternoon_start:18,afternoon_end:21},3:{start:9,end:14,afternoon_start:18,afternoon_end:21},4:{start:9,end:14,afternoon_start:18,afternoon_end:21},5:{start:9,end:14,afternoon_start:18,afternoon_end:21},6:{start:9,end:14,afternoon_start:18,afternoon_end:21}};const DOM_ELEMENTS={service:document.getElementById('service-select'),doctor:document.getElementById('doctor-select'),name:document.getElementById('name-input'),email:document.getElementById('email-input'),date:document.getElementById('appointment-date'),time:document.getElementById('appointment-time'),message:document.getElementById('message-input'),form:document.getElementById('appointment-form'),submitBtn:document.getElementById('submit-btn')};const ERROR_ELEMENTS={service:document.getElementById('service-error'),doctor:document.getElementById('doctor-error'),name:document.getElementById('name-error'),email:document.getElementById('email-error'),date:document.getElementById('date-error'),time:document.getElementById('time-error')};function showToast(message,type="info"){const toastEl=document.getElementById("validationToast");const toastBody=document.getElementById("toastMessage");toastBody.textContent=message;const bgClass={"danger":"text-bg-danger","warning":"text-bg-warning","success":"text-bg-success","info":"text-bg-info"}[type]||"text-bg-info";toastEl.className=`toast align-items-center ${bgClass} border-0 animated-toast`;new bootstrap.Toast(toastEl).show();}
function validateName(){const name=DOM_ELEMENTS.name.value.trim();const nameRegex=/^[a-zA-Z\s]{2,50}$/;if(!name){ERROR_ELEMENTS.name.textContent="Name is required";ERROR_ELEMENTS.name.style.display='block';DOM_ELEMENTS.name.classList.add('form-error');return false;}
if(!nameRegex.test(name)){ERROR_ELEMENTS.name.textContent="Name must contain only letters (2-50 characters)";ERROR_ELEMENTS.name.style.display='block';DOM_ELEMENTS.name.classList.add('form-error');return false;}
ERROR_ELEMENTS.name.style.display='none';DOM_ELEMENTS.name.classList.remove('form-error');return true;}
function validateEmail(){const email=DOM_ELEMENTS.email.value.trim();const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!email){ERROR_ELEMENTS.email.textContent="Email is required";ERROR_ELEMENTS.email.style.display='block';DOM_ELEMENTS.email.classList.add('form-error');return false;}
if(!emailRegex.test(email)){ERROR_ELEMENTS.email.textContent="Please enter a valid email address";ERROR_ELEMENTS.email.style.display='block';DOM_ELEMENTS.email.classList.add('form-error');return false;}
ERROR_ELEMENTS.email.style.display='none';DOM_ELEMENTS.email.classList.remove('form-error');return true;}
function validateDate(){const dateStr=DOM_ELEMENTS.date.value;if(!dateStr){ERROR_ELEMENTS.date.textContent="Date is required";ERROR_ELEMENTS.date.style.display='block';DOM_ELEMENTS.date.classList.add('form-error');return false;}
const date=new Date(dateStr+'T00:00:00');const today=new Date();today.setHours(0,0,0,0);if(date<today){ERROR_ELEMENTS.date.textContent="Cannot book appointments in the past";ERROR_ELEMENTS.date.style.display='block';DOM_ELEMENTS.date.classList.add('form-error');return false;}
if(date.getDay()===0){ERROR_ELEMENTS.date.textContent="Our clinic is closed on Sundays";ERROR_ELEMENTS.date.style.display='block';DOM_ELEMENTS.date.classList.add('form-error');showToast("Cannot book appointments on Sunday. Our clinic is closed.","warning");return false;}
ERROR_ELEMENTS.date.style.display='none';DOM_ELEMENTS.date.classList.remove('form-error');return true;}
function validateTime(){const timeStr=DOM_ELEMENTS.time.value;const dateStr=DOM_ELEMENTS.date.value;if(!timeStr){ERROR_ELEMENTS.time.textContent="Time is required";ERROR_ELEMENTS.time.style.display='block';DOM_ELEMENTS.time.classList.add('form-error');return false;}
if(!dateStr){ERROR_ELEMENTS.time.textContent="Please select date first";ERROR_ELEMENTS.time.style.display='block';DOM_ELEMENTS.time.classList.add('form-error');return false;}
const date=new Date(dateStr+'T00:00:00');const dayOfWeek=date.getDay();const hours=OPENING_HOURS[dayOfWeek];if(!hours){ERROR_ELEMENTS.time.textContent="Clinic is closed on this day";ERROR_ELEMENTS.time.style.display='block';DOM_ELEMENTS.time.classList.add('form-error');return false;}
const[hour,minute]=timeStr.split(':').map(Number);const isMorningSlot=hour>=hours.start&&(hour<hours.end||(hour===hours.end&&minute===0));const isAfternoonSlot=hour>=hours.afternoon_start&&(hour<hours.afternoon_end||(hour===hours.afternoon_end&&minute===0));if(!isMorningSlot&&!isAfternoonSlot){ERROR_ELEMENTS.time.textContent="Time must be 9 AM-2 PM or 6 PM-9 PM";ERROR_ELEMENTS.time.style.display='block';DOM_ELEMENTS.time.classList.add('form-error');showToast("Selected time is outside working hours (09:00–14:00 & 18:00–21:00)","danger");return false;}
ERROR_ELEMENTS.time.style.display='none';DOM_ELEMENTS.time.classList.remove('form-error');return true;}
function checkSlotAvailability(){if(!validateDate()||!validateTime())return;const doctor_email=DOM_ELEMENTS.doctor.value;const date=DOM_ELEMENTS.date.value;const time=DOM_ELEMENTS.time.value;if(!doctor_email||!date||!time)return;const csrfToken=document.querySelector('[name=csrfmiddlewaretoken]').value;fetch("/check-slot/",{method:"POST",headers:{"X-CSRFToken":csrfToken,"Content-Type":"application/x-www-form-urlencoded"},body:`doctor_email=${encodeURIComponent(doctor_email)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}`}).then(res=>res.json()).then(data=>{if(data.available===false){ERROR_ELEMENTS.time.textContent="This slot is already booked. Please choose another.";ERROR_ELEMENTS.time.style.display='block';DOM_ELEMENTS.time.classList.add('form-error');showToast("Selected slot is already booked.","warning");DOM_ELEMENTS.time.value='';}else{ERROR_ELEMENTS.time.style.display='none';DOM_ELEMENTS.time.classList.remove('form-error');}}).catch(err=>{console.error("Slot availability check failed:",err);showToast("Error checking availability. Please try again.","danger");});}
DOM_ELEMENTS.name.addEventListener('blur',validateName);DOM_ELEMENTS.email.addEventListener('blur',validateEmail);DOM_ELEMENTS.date.addEventListener('change',()=>{validateDate();if(DOM_ELEMENTS.time.value)checkSlotAvailability();});DOM_ELEMENTS.time.addEventListener('change',checkSlotAvailability);DOM_ELEMENTS.doctor.addEventListener('change',()=>{if(DOM_ELEMENTS.time.value&&DOM_ELEMENTS.date.value)checkSlotAvailability();});DOM_ELEMENTS.form.addEventListener('submit',(e)=>{const isNameValid=validateName();const isEmailValid=validateEmail();const isDateValid=validateDate();const isTimeValid=validateTime();const isServiceValid=DOM_ELEMENTS.service.value!=='';const isDoctorValid=DOM_ELEMENTS.doctor.value!=='';if(!isNameValid||!isEmailValid||!isDateValid||!isTimeValid||!isServiceValid||!isDoctorValid){e.preventDefault();showToast("Please fix all errors before submitting","danger");}});;
{% load static %}
{% load crispy_forms_tags %}
{% load socialaccount %}
{% get_providers as providers %}

<!DOCTYPE html>
<html lang="en">

{% include "head_template.html" %}

<body>

    {% include "header.html" %}

    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-7">

                <h1 class="mb-4">Create Account</h1>

                <!-- Django Messages -->
                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
                {% endif %}

                <form id="registration-form" method="POST" action="{% url 'custom_register' %}">
                    {% csrf_token %}

                    <!-- Username with AJAX validation -->
                    <div class="mb-3 position-relative">
                        {{ register_form.username|as_crispy_field }}
                        <div id="username-feedback" class="invalid-feedback d-block"></div>
                        <div id="username-spinner"
                            class="spinner-border spinner-border-sm text-primary d-none position-absolute"
                            style="right: 10px; top: 38px;">
                        </div>
                    </div>

                    <!-- Email with AJAX validation -->
                    <div class="mb-3 position-relative">
                        {{ register_form.email|as_crispy_field }}
                        <div id="email-feedback" class="invalid-feedback d-block"></div>
                        <div id="email-spinner"
                            class="spinner-border spinner-border-sm text-primary d-none position-absolute"
                            style="right: 10px; top: 38px;">
                        </div>
                    </div>

                    {{ register_form.first_name|as_crispy_field }}
                    {{ register_form.last_name|as_crispy_field }}
                    {{ register_form.password1|as_crispy_field }}
                    {{ register_form.password2|as_crispy_field }}

                    <button id="submit-btn" type="submit" class="btn btn-primary w-100" disabled>
                        Register
                    </button>
                </form>

                <p class="text-center mt-3">
                    Already have an account?
                    <a href="{% url 'custom_login' %}">Login here</a>.
                </p>

                <!-- Social Login -->
                <!-- Other providers -->
                <div class="d-grid gap-2 mt-3">
                    {% for provider in providers %}
                    {% if provider.id == "google" %}
                    <a href="{% provider_login_url provider.id process='login' %}"
                        class="btn btn-outline-dark d-flex align-items-center justify-content-center gap-2">

                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"
                            style="width: 20px; height: 20px;">

                        <span>Continue with Google</span>
                    </a>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>


        </div>
        </div>
    </main>

    {% include "footer.html" %}

    <!-- ===========================
         AJAX USERNAME + EMAIL CHECK
    ============================ -->
    <script>
        let usernameTimer;
        let emailTimer;
        let usernameOK = false;
        let emailOK = false;

        const usernameField = document.getElementById("id_username");
        const emailField = document.getElementById("id_email");
        const usernameFeedback = document.getElementById("username-feedback");
        const emailFeedback = document.getElementById("email-feedback");
        const spinnerUser = document.getElementById("username-spinner");
        const spinnerEmail = document.getElementById("email-spinner");
        const submitBtn = document.getElementById("submit-btn");

        function updateSubmit() {
            submitBtn.disabled = !(usernameOK && emailOK);
        }

        /* -------------------------
           USERNAME CHECK
        -------------------------- */
        usernameField?.addEventListener("input", () => {
            clearTimeout(usernameTimer);
            const value = usernameField.value.trim();

            usernameOK = false;
            updateSubmit();

            usernameField.classList.remove("is-valid", "is-invalid");
            usernameFeedback.textContent = "";
            spinnerUser.classList.remove("d-none");

            if (value.length < 3) {
                spinnerUser.classList.add("d-none");
                if (value.length > 0) {
                    usernameField.classList.add("is-invalid");
                    usernameFeedback.textContent = "Username must be at least 3 characters.";
                }
                return;
            }

            usernameTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`{% url 'check_availability' %}?username=${encodeURIComponent(value)}`);
                    const data = await res.json();

                    spinnerUser.classList.add("d-none");

                    if (data.is_taken) {
                        usernameField.classList.add("is-invalid");
                        usernameFeedback.textContent =
                            data.suggestion
                                ? `Username is taken. Try: ${data.suggestion}`
                                : "Username is already taken.";
                        usernameOK = false;
                    } else {
                        usernameField.classList.add("is-valid");
                        usernameOK = true;
                    }
                } catch (err) {
                    spinnerUser.classList.add("d-none");
                    usernameField.classList.add("is-invalid");
                    usernameFeedback.textContent = "Error checking username.";
                    usernameOK = false;
                }

                updateSubmit();
            }, 500);
        });

        /* -------------------------
           EMAIL CHECK (checks both User and SocialAccount)
        -------------------------- */
        emailField?.addEventListener("input", () => {
            clearTimeout(emailTimer);
            const value = emailField.value.trim();

            emailOK = false;
            updateSubmit();

            emailField.classList.remove("is-valid", "is-invalid");
            emailFeedback.textContent = "";
            spinnerEmail.classList.remove("d-none");

            if (!value.includes("@") || value.length < 5) {
                spinnerEmail.classList.add("d-none");
                if (value.length > 0) {
                    emailField.classList.add("is-invalid");
                    emailFeedback.textContent = "Enter a valid email.";
                }
                return;
            }

            emailTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`{% url 'check_availability' %}?email=${encodeURIComponent(value)}`);
                    const data = await res.json();

                    spinnerEmail.classList.add("d-none");

                    if (data.is_taken) {
                        emailField.classList.add("is-invalid");
                        emailFeedback.textContent = "Email already registered (regular or social login).";
                        emailOK = false;
                    } else {
                        emailField.classList.add("is-valid");
                        emailOK = true;
                    }
                } catch (err) {
                    spinnerEmail.classList.add("d-none");
                    emailField.classList.add("is-invalid");
                    emailFeedback.textContent = "Error checking email.";
                    emailOK = false;
                }

                updateSubmit();
            }, 500);
        });

        /* -------------------------
           PREVENT DOUBLE SUBMIT
        -------------------------- */
        document.getElementById("registration-form").addEventListener("submit", e => {
            if (!usernameOK || !emailOK) {
                e.preventDefault();
                alert("Please fix all validation errors before submitting.");
            } else {
                submitBtn.disabled = true;
                submitBtn.textContent = "Registering...";
            }
        });

    </script>

</body>

</html>